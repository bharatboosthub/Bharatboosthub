<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Coins - Bharat Boost Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; } 
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="dashboard.html" class="flex items-center space-x-3">
                <div class="bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">BB</div>
                <h1 class="text-lg font-bold text-gray-800">Bharat Boost Hub</h1>
            </a>
            <a href="dashboard.html" class="text-gray-600 hover:text-red-600 font-semibold transition">‚Üê Back to Dashboard</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div id="earn-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-md max-w-3xl mx-auto">
            
            <!-- VIEW 1: Start Task -->
            <div id="start-view" class="hidden">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Complete the Task to Earn</h2>
                    <p class="text-gray-500 mt-1">Click below to open YouTube. Watch, like, and subscribe, then return after 3 minutes.</p>
                </div>
                <div id="video-thumbnail-area" class="my-6 aspect-video bg-black rounded-lg overflow-hidden flex items-center justify-center text-gray-400"></div>
                <button id="start-task-btn" class="w-full bg-red-600 text-white font-bold py-3 text-lg rounded-lg hover:bg-red-700 transition-all flex items-center justify-center space-x-2">Start Task & Open YouTube</button>
            </div>

            <!-- VIEW 2: Waiting for user to return -->
            <div id="waiting-view" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800">Task in Progress...</h2>
                <div class="my-8">
                    <div class="text-5xl font-bold text-red-600" id="timer-display">03:00</div>
                </div>
            </div>

            <!-- VIEW 3: Claim Reward -->
            <div id="claim-view" class="hidden text-center">
                <h2 class="text-2xl font-bold text-green-600 mt-2">Task Complete!</h2>
                <button id="claim-btn" class="w-full max-w-sm mx-auto mt-8 bg-green-500 text-white font-bold py-3 text-lg rounded-lg hover:bg-green-600 transition-all">Claim Reward (+1 Coin)</button>
            </div>
        </div>
        
        <div id="no-videos-container" class="hidden text-center bg-white p-12 rounded-lg shadow-md max-w-3xl mx-auto">
            <h3 class="text-2xl font-bold text-gray-800">No Videos to Watch</h2>
            <p class="text-gray-600 mt-2">There are currently no videos from other users to review. Check back later!</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI & LOGIC VARIABLES ---
            const [earnContainer, noVideosContainer, startView, waitingView, claimView, thumbnailArea, timerDisplay, startTaskBtn, claimBtn] = 
                ['earn-container', 'no-videos-container', 'start-view', 'waiting-view', 'claim-view', 'video-thumbnail-area', 'timer-display', 'start-task-btn', 'claim-btn'].map(id => document.getElementById(id));
            
            const requiredWatchTime = 3 * 60 * 1000;
            let timerInterval;

            // --- USER & VIDEO MANAGEMENT ---
            function getOrCreateUserId() {
                let userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    userId = 'user_' + Date.now() + Math.random().toString(36).substring(2, 9);
                    localStorage.setItem('currentUserId', userId);
                }
                return userId;
            }
            
            const currentUserId = getOrCreateUserId();
            const allPromotedVideos = JSON.parse(localStorage.getItem('promotedVideos')) || [];
            
            // ** THE CORE NEW FEATURE: FILTER OUT THE USER'S OWN VIDEOS **
            const videosToWatch = allPromotedVideos.filter(video => video.uploaderId !== currentUserId);
            
            let currentVideoIndex = 0;

            // --- CORE FUNCTIONS ---
            function switchView(viewToShow) {
                [startView, waitingView, claimView].forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
            }

            function loadVideoForTask(index) {
                if (videosToWatch.length > 0 && index < videosToWatch.length) {
                    earnContainer.classList.remove('hidden');
                    noVideosContainer.classList.add('hidden');
                    const videoId = getYouTubeVideoId(videosToWatch[index].url);
                    thumbnailArea.innerHTML = `<img src="https://i3.ytimg.com/vi/${videoId}/hqdefault.jpg" class="w-full h-full object-cover" alt="Video Thumbnail">`;
                    switchView(startView);
                } else {
                    earnContainer.classList.add('hidden');
                    noVideosContainer.classList.remove('hidden');
                }
            }

            function startTask() {
                localStorage.setItem('taskStartTime', Date.now());
                window.open(videosToWatch[currentVideoIndex].url, '_blank');
                switchView(waitingView);
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                const startTime = parseInt(localStorage.getItem('taskStartTime'), 10);
                if (!startTime) { clearInterval(timerInterval); return; }
                
                const remainingTime = Math.max(0, requiredWatchTime - (Date.now() - startTime));
                timerDisplay.textContent = new Date(remainingTime).toISOString().substr(14, 5);

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    switchView(claimView);
                }
            }

            function claimReward() {
                let currentCoins = parseInt(localStorage.getItem('userCoins') || '0');
                currentCoins += 1; // User earns 1 coin for completing a task
                localStorage.setItem('userCoins', currentCoins);
                localStorage.removeItem('taskStartTime');
                
                alert('Congratulations! 1 coin has been added to your account.');
                
                currentVideoIndex++;
                loadVideoForTask(currentVideoIndex);
            }

            function checkTaskStateOnLoad() {
                const startTime = localStorage.getItem('taskStartTime');
                if (startTime) {
                    switchView(waitingView);
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                } else {
                    loadVideoForTask(currentVideoIndex);
                }
            }
            
            startTaskBtn.addEventListener('click', startTask);
            claimBtn.addEventListener('click', claimReward);

            function getYouTubeVideoId(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }

            checkTaskStateOnLoad();
        });
    </script>
</body>
</html>
