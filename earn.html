<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Earn Coins - Bharat Boost Hub</title>
    <meta name="description" content="Watch videos from other creators, engage with their content, and earn coins to promote your own channel." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; } 
    </style>
</head>
<body class="antialiased">
    <header class="bg-white border-b">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold text-gray-800">Bharat Boost Hub</h1>
            <a href="dashboard.html" class="inline-flex items-center text-gray-600 hover:text-gray-900 font-medium transition-colors">
                <span class="material-symbols-outlined">arrow_back</span><span class="ml-1">Back to Dashboard</span>
            </a>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="earn-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-3xl mx-auto">
            <!-- VIEW 1: Start Task -->
            <div id="start-view" class="hidden">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Complete the Task to Earn</h2>
                    <p class="text-gray-500 mt-1">Click below, engage for 3 minutes, then return to claim.</p>
                </div>
                <div id="video-thumbnail-area" class="my-6 aspect-video bg-black rounded-lg overflow-hidden shadow-inner">
                    <!-- Thumbnail will be loaded here -->
                </div>
                <button id="start-task-btn" class="w-full bg-red-600 text-white font-bold py-3 text-lg rounded-lg hover:bg-red-700 transition-all shadow-md hover:shadow-lg hover:transform hover:-translate-y-0.5">Start Task & Open YouTube</button>
            </div>

            <!-- VIEW 2: Waiting for user to return -->
            <div id="waiting-view" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800">Task in Progress...</h2>
                <p class="text-gray-500 mt-1">Return to this page after engaging with the video.</p>
                <div class="my-8">
                    <div class="text-5xl font-bold text-red-600" id="timer-display">03:00</div>
                </div>
            </div>

            <!-- VIEW 3: Claim Reward -->
            <div id="claim-view" class="hidden text-center">
                <span class="material-symbols-outlined text-green-500 !text-6xl">task_alt</span>
                <h2 class="text-2xl font-bold text-green-500 mt-2">Task Complete!</h2>
                <button id="claim-btn" class="w-full max-w-sm mx-auto mt-8 bg-green-500 text-white font-bold py-3 text-lg rounded-lg hover:bg-green-600 shadow-lg hover:shadow-xl transition-all">Claim Reward (+1 Coin)</button>
            </div>
        </div>
        
        <!-- View for No Videos Available -->
        <div id="no-videos-container" class="hidden text-center bg-white p-12 rounded-lg shadow-lg max-w-3xl mx-auto">
            <span class="material-symbols-outlined text-gray-400 !text-6xl">hourglass_empty</span>
            <h3 class="text-2xl font-bold text-gray-800 mt-4">No Videos to Watch</h3>
            <p class="text-gray-600 mt-2">There are currently no videos from other users to review. Check back later!</p>
        </div>
    </main>

    <!-- Firebase SDKs (v8 for compatibility with your code) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // âœ… Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBOnW5Mv5YYquR1I9_Nn1ViprMVVOoubbM",
            authDomain: "bharat-boost-hub.firebaseapp.com",
            projectId: "bharat-boost-hub",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get references to all UI elements
        const earnContainer = document.getElementById('earn-container');
        const noVideosContainer = document.getElementById('no-videos-container');
        const startView = document.getElementById('start-view');
        const waitingView = document.getElementById('waiting-view');
        const claimView = document.getElementById('claim-view');
        const thumbnailArea = document.getElementById('video-thumbnail-area');
        const timerDisplay = document.getElementById('timer-display');
        const startTaskBtn = document.getElementById('start-task-btn');
        const claimBtn = document.getElementById('claim-btn');
        
        // Logic variables
        const currentUserId = localStorage.getItem('currentUserId') || 'anonymous';
        let videosToWatch = [];
        let currentVideoIndex = 0;
        const requiredWatchTime = 3 * 60 * 1000; // 3 minutes
        let timerInterval;

        // Function to switch between the three main views
        function switchView(viewToShow) {
            [startView, waitingView, claimView].forEach(v => v.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        }

        // Fetches videos from Firestore and prepares the first task
        async function prepareNextTask() {
            if (currentVideoIndex >= videosToWatch.length) { // Only fetch if we've run out of videos
                const snapshot = await db.collection('promotedVideos').get();
                const allVideos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                videosToWatch = allVideos.filter(v => v.uploaderId !== currentUserId);
                currentVideoIndex = 0; // Reset index
            }

            if (videosToWatch.length > 0 && currentVideoIndex < videosToWatch.length) {
                earnContainer.classList.remove('hidden');
                noVideosContainer.classList.add('hidden');
                const video = videosToWatch[currentVideoIndex];
                const videoId = getYouTubeVideoId(video.url);
                thumbnailArea.innerHTML = `<img src="https://i3.ytimg.com/vi/${videoId}/hqdefault.jpg" class="w-full h-full object-cover" alt="Video Thumbnail">`;
                switchView(startView);
            } else {
                // No more videos available from anyone
                earnContainer.classList.add('hidden');
                noVideosContainer.classList.remove('hidden');
            }
        }
        
        // This function runs when the user clicks "Start Task"
        function startTask() {
            localStorage.setItem('taskStartTime', Date.now());
            // Open the YouTube video in a new tab
            window.open(videosToWatch[currentVideoIndex].url, '_blank');
            // Switch to the timer view
            switchView(waitingView);
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // This function updates the countdown timer on the screen
        function updateTimer() {
            const startTime = parseInt(localStorage.getItem('taskStartTime'), 10);
            if (!startTime) { clearInterval(timerInterval); return; }
            const remainingTime = Math.max(0, requiredWatchTime - (Date.now() - startTime));
            // Format time as MM:SS
            timerDisplay.textContent = new Date(remainingTime).toISOString().substr(14, 5);
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                switchView(claimView); // Timer finished, show the claim button
            }
        }
        
        // This function runs when the user clicks "Claim Reward"
        function claimReward() {
            let currentCoins = parseInt(localStorage.getItem('userCoins') || '0');
            currentCoins += 1; // User earns 1 coin for completing a task
            localStorage.setItem('userCoins', currentCoins);
            localStorage.removeItem('taskStartTime');
            
            alert('Congratulations! 1 coin has been added to your account.');
            
            currentVideoIndex++; // Move to the next video
            prepareNextTask(); // Load the next task
        }

        // This function checks if a task was already in progress when the page loads
        function checkTaskStateOnLoad() {
            const startTime = localStorage.getItem('taskStartTime');
            if (startTime) {
                const remainingTime = Math.max(0, requiredWatchTime - (Date.now() - startTime));
                if (remainingTime <= 0) {
                    switchView(claimView);
                } else {
                    switchView(waitingView);
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                }
            } else {
                prepareNextTask(); // No task in progress, just load a new one
            }
        }
        
        // Helper function to get the video ID from a YouTube URL
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Add event listeners to the buttons
        startTaskBtn.addEventListener('click', startTask);
        claimBtn.addEventListener('click', claimReward);

        // Initial check when the page loads
        checkTaskStateOnLoad();
    </script>
</body>
</html>
